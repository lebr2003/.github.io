<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
    <title>Arzneimittel</title>
<link rel="apple-touch-icon" sizes="180x180" href="https://apotheke.leanderbrunar.net/ico/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://apotheke.leanderbrunar.net/ico/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://apotheke.leanderbrunar.net/ico/favicon-16x16.png">
<link rel="manifest" href="https://apotheke.leanderbrunar.net/ico/site.webmanifest">
    
<script lang="javascript" src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

        <script>




window.addEventListener('beforeunload', function (e) {
    const unsavedWarning = document.getElementById('unsavedWarning');
    if (unsavedWarning && unsavedWarning.style.display !== 'none') {
        const message = "Haben Sie die Datei hochgeladen? Die Datei wird lokal gelöscht, sobald Sie die Seite verlassen oder neu laden.";
        e.returnValue = message; // Zeigt in unterstützten Browsern die Warnung an
        return message; // Manche Browser ignorieren returnValue und verwenden eine Standardnachricht
    }
});


    </script>


    <style>
body {
    font-family: Calibri, sans-serif;
    margin-top: 30px;
    overflow: hidden;
}
         .header-words {
        display: flex;
        margin-top: 10px;
        margin-left: 25px;
        margin-bottom: 10px;
        font-weight: bold;
    }

    .word-spacing-Menge {
        margin-left: 37px; /* Ändern Sie den Wert nach Bedarf, um den gewünschten Abstand zwischen den Wörtern zu setzen */
    }

    .word-spacing-Ablaufdatum {
        margin-left: 23px; /* Ändern Sie den Wert nach Bedarf, um den gewünschten Abstand zwischen den Wörtern zu setzen */
    }

    .word-spacing-Wirkstoff {
        margin-left: 108px; /* Ändern Sie den Wert nach Bedarf, um den gewünschten Abstand zwischen den Wörtern zu setzen */
    }

    .word-spacing-Bezeichnung {
        margin-left: 147px; /* Ändern Sie den Wert nach Bedarf, um den gewünschten Abstand zwischen den Wörtern zu setzen */
    }

    .word-spacing-BarcodeD {
        margin-left: 15px; /* Ändern Sie den Wert nach Bedarf, um den gewünschten Abstand zwischen den Wörtern zu setzen */
    }

    .word-spacing-BezeichnungD {
        margin-left: 55px; /* Ändern Sie den Wert nach Bedarf, um den gewünschten Abstand zwischen den Wörtern zu setzen */
    }
    
    .word-spacing-MindMengeD {
        margin-left: 40px; /* Ändern Sie den Wert nach Bedarf, um den gewünschten Abstand zwischen den Wörtern zu setzen */
    }

    .word-spacing-WirkstoffD {
        margin-left: 110px; /* Ändern Sie den Wert nach Bedarf, um den gewünschten Abstand zwischen den Wörtern zu setzen */
    }

    .word-spacing-LagerortD {
        margin-left: 110px; /* Ändern Sie den Wert nach Bedarf, um den gewünschten Abstand zwischen den Wörtern zu setzen */
    }


          .table-container {
        position: relative;
        height: 70vh;
        overflow: auto; /* Fügt den Scrollbalken hinzu, wenn der Inhalt die Höhe überschreitet */
    }

        .container-form2 {
        max-height: 70vh;
        overflow-y: auto;
    }

      
       #dataTable {
        width: 720px; /* Breite der gesamten Tabelle */
    }


     #dataTable td:nth-child(1) {
         width: 96px; /* Breite der ersten Spalte */
     }

     #dataTable td:nth-child(2) {
         width: 80px; /* Breite der zweiten Spalte */
     }

     #dataTable td:nth-child(3) {
         width: 99px; /* Breite der dritten Spalte */
     }

     #dataTable td:nth-child(4) {
         width: 262px; /* Breite der vierten Spalte */
     }

     #dataTable td:nth-child(5) {
         width: 183px; /* Breite der fünften Spalte */
     }

        
       #tableB {
        width: 720px; /* Breite der gesamten Tabelle */
    }


     #tableB td:nth-child(1) {
         width: 96px; /* Breite der ersten Spalte */
     }

     #tableB td:nth-child(2) {
         width: 80px; /* Breite der zweiten Spalte */
     }

     #tableB td:nth-child(3) {
         width: 99px; /* Breite der dritten Spalte */
     }

     #tableB td:nth-child(4) {
         width: 262px; /* Breite der vierten Spalte */
     }

     #tableB td:nth-child(5) {
         width: 183px; /* Breite der fünften Spalte */
     }


        #tableD {
        width: 720px; /* Breite der gesamten Tabelle */
        }

        #tableD th, #tableD td {
        width: 120px; /* Breite der ersten drei Spalten */
        }

        #tableD td:nth-child(4) {
        width: 240px; /* Breite der vierten Spalte */
        }



        .großer-abstand {
            margin-top: 70px; /* Ändere den Wert nach deinen Wünschen */
        }

        .info-button {
            display: inline-block;
            margin-left: 10px;
            cursor: pointer;
        }

.text-input-container {
            margin-top: 10px;
        }

        .text-input-container input {
            margin-right: 10px;
        }

.red-button {
            background-color: red;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
.green-button {
            background-color: green;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
.blue-button {
            background-color: blue;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

.unsaved-warning {
    white-space: nowrap; /* Verhindert Zeilenumbrüche */
    background-color: yellow; /* Hintergrundfarbe auf Gelb setzen */
    padding: 5px 10px; /* Raum um den Text herum hinzufügen */
    border-radius: 5px; /* Abrundung der Ecken */
    color: red; /* Textfarbe auf Schwarz setzen */
    display: none; /* Standardmäßig ausblenden */
    margin-left: 30px; /* Abstand zum Switch */
}

/* README-Popup (standardmäßig ausgeblendet) */
.popup {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 1;
}

.popup-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: #fff;
    padding: 20px;
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    max-width: 80%;
    max-height: 80%;
    overflow: auto;
}


.close {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 20px;
    cursor: pointer; /* Ändert den Cursor-Stil zu "pointer" */
}

/* Füge diese CSS-Regel hinzu, um die bearbeitbare Tabelle zu gestalten */
.editable {
    background-color: #f7f7f7; /* Hintergrundfarbe für bearbeitbare Tabellen */
    border: 1px solid #2196F3; /* Rahmen für bearbeitbare Tabellen */
    cursor: text; /* Zeiger-Cursor für bearbeitbare Tabellen */
}

/* Stil für den Switch */
.switch {
  position: relative;
  display: inline-flex;
  align-items: center; /* Vertikal ausrichten */
  width: 40px; /* Breite des Switch-Containers */
  height: 20px; /* Höhe des Switch-Containers */
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  -webkit-transition: .4s;
  transition: .4s;
  border-radius: 20px; /* Runder Slider */
}

.slider:before {
  position: absolute;
  content: "";
  height: 16px; /* Höhe des runden Teils des Sliders */
  width: 16px; /* Breite des runden Teils des Sliders */
  left: 2px; /* Abstand links zum runden Teil des Sliders */
  bottom: 2px; /* Abstand unten zum runden Teil des Sliders */
  background-color: white;
  -webkit-transition: .4s;
  transition: .4s;
  border-radius: 50%; /* Runde Form des runden Teils des Sliders */
}

input:checked + .slider {
  background-color: #2196F3;
}

input:focus + .slider {
  box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
  -webkit-transform: translateX(19px);
  -ms-transform: translateX(19px);
  transform: translateX(19px);
}

/* Füge diese CSS-Regel hinzu, um die Buttons zu verblassen, wenn sie die Klasse "disabled-button" haben */
button.disabled-button {
    opacity: 0.5; /* Opazität ändern, um den Button zu verblassen */
}

.logo {
            position: absolute;
            top: 0;
            right: 0;
            margin: 30px; /* Anpassen des Abstands nach Bedarf */
            max-height: 50px; /* Anpassen der maximalen Höhe nach Bedarf */
        }



    </style>
</head>
<body>
    <img class="logo" src="https://apotheke.leanderbrunar.net/Maltalogo.png" alt="Logo">
<h1>Arzneimittel</h1>

 <form id="form1">

<input type="file" id="fileInput" style="display: none;" />
<button type="button" onclick="importButton()" style="margin-right: 25px;">Importieren</button>
<button type="button" onclick="refreshTable()">Refresh</button>
<button type="button" onclick="sortTableByWirkstoff()" style="margin-right: 25px;">Ordnen nach Wirkstoff</button>
<button type="button" onclick="openReadmePopup()">README</button>
<button type="button" type="button" class="blue-button" onclick="openComparisonTable()">Menge</button>
<button class="green-button" onclick="saveButton()">Speichern</button>
<button type="button" onclick="exportButton()">Extern Speichern</button>
<label class="switch">
  <input type="checkbox" id="editToggle">
  <span class="slider round"></span>
<span id="unsavedWarning" class="unsaved-warning"><strong>Tabelle nicht gespeichert!</strong></span>
</label>




<!-- README-Popup -->
<div id="readmePopup" class="popup">
    <div class="popup-content">
        <span class="close" onclick="closeReadmePopup()">&times;</span>
        <h2>README</h2>
        <div id="readmeContent">Lade Inhalt...</div>
    </div>
</div>




    <div class="text-input-container">
        <!-- Texteingabefelder -->
        <input type="text" placeholder="Barcode">
        <input type="text" placeholder="Menge">
        <input type="text" placeholder="Ablaufdatum">
        <input type="text" placeholder="Wirkstoff">
        <input type="text" placeholder="Bezeichnung">
<button type="button" onclick="search()">Suchen</button>
<button type="button" class="red-button" onclick="addNewEntry()">Neuer Eintrag</button>
</div>


<div class="header-words">
    <span>Barcode</span>
    <span class="word-spacing-Menge">Menge</span>
    <span class="word-spacing-Ablaufdatum">Ablaufdatum</span>
    <span class="word-spacing-Wirkstoff">Wirkstoff</span>
    <span class="word-spacing-Bezeichnung">Bezeichnung</span>
</div>
     
    <div class="table-container">
        <table id="dataTable" border="1">
            <!-- Weitere Tabellenzeilen hier einfügen -->
        </table>
    </div>


</form>


<form id="form2" style="display: none;">
<button type="button" class="blue-button" onclick="returnToForm1()">X</button>
<input type="file" id="excelFileInput" style="display: none;" />
<button type="button" onclick="compareAndDisplay()" style="margin-left: 10px;">Vergleichen</button>

    <div class="header-words">
        <span>Barcode</span>
        <span class="word-spacing-Menge">Menge</span>
        <span class="word-spacing-Ablaufdatum">Min. Menge</span>
        <span class="word-spacing-Wirkstoff">Wirkstoff</span>
        <span class="word-spacing-Bezeichnung">Bezeichnung</span>
    </div>

<div class="container-form2"> 

     <div>
        <table id="tableB" border="1">
            <!-- Hier fügen Sie Ihre Tabelle für Formular 2 ein -->
        </table>
    </div>


 <p class="großer-abstand">Produkte, die nicht im Inventar enthalten sind:</p>


    <div class="header-words">
        <span class="word-spacing-BarcodeD">Barcode</span>
        <span class="word-spacing-BezeichnungD">Bezeichnung</span>
        <span class="word-spacing-MindMengeD">Min. Menge</span>
        <span class="word-spacing-WirkstoffD">Wirkstoff</span>
        <span class="word-spacing-LagerortD">Lagerort</span>
    </div>
    
    <div>
        <table id="tableD" border="1">
            <!-- Hier fügen Sie Ihre Tabelle für Formular 2 ein -->
        </table>
    </div>
</div>

    <div class="table-container">
        <table id="tableC">
            <!-- Hier fügen Sie Ihre Tabelle für Formular 2 ein -->
        </table>
    </div>

</form>



    <script>

// Event-Listener für DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    importTextFileFromCloud();  // Diese Funktion wird aufgerufen, wenn der HTML-Inhalt geladen ist
});


// Funktion, um den Access Token aus dem LocalStorage zu holen
function getAccessTokenFromLocalStorage() {
    return localStorage.getItem("access_token");
}

// Funktion, um zu überprüfen, ob der Token gültig ist, indem ein API-Aufruf zu Dropbox gemacht wird
function checkTokenValidity(token) {
    return new Promise((resolve, reject) => {
        const url = 'https://api.dropboxapi.com/2/users/get_current_account';
        const headers = new Headers();
        headers.append('Authorization', 'Bearer ' + token);

        fetch(url, {
            method: 'POST',
            headers: headers,
        })
        .then(response => {
            if (response.ok) {
                resolve(true);  // Der Token ist gültig
            } else {
                resolve(false); // Der Token ist ungültig
            }
        })
        .catch(error => {
            reject(false); // Fehler beim Abrufen der Account-Informationen, Token ungültig
        });
    });
}

// Funktion, um API zu überprüfen und die Datei von Dropbox herunterzuladen und die Tabelle zu erstellen
function importTextFileFromCloud() {
    const accessToken = getAccessTokenFromLocalStorage();  // Den Access Token aus dem LocalStorage holen
    const dropboxFilePath = '/Apotheke/Arzneimittel/Arzneimittel_Inventar.txt';

    if (!accessToken) {
        const userConfirmed = confirm("Kein Access Token gefunden. Bitte melden Sie sich an.");
        if (userConfirmed) {
            // Umleitung, wenn der Benutzer auf "OK" klickt
            window.location.href = '../login.html';
        }
    } else {
        // Token Überprüfung
        checkTokenValidity(accessToken)
            .then(isValid => {
                if (!isValid) {
                    const userConfirmed = confirm("Der Access Token ist ungültig. Bitte melden Sie sich erneut an.");
                    if (userConfirmed) {
                        // Umleitung, wenn der Benutzer auf "OK" klickt
                        window.location.href = '../login.html';
                    }
                } else {
                    console.log("Token gültig: " + accessToken);
                    importBibliothekFromCloud();

                    // API-Aufruf, um die Datei von Dropbox herunterzuladen
                    fetch('https://content.dropboxapi.com/2/files/download', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + accessToken,
                            'Dropbox-API-Arg': JSON.stringify({
                                path: dropboxFilePath
                            })
                        }
                    })
                    .then(response => {
                        if (!response.ok) {
                            // Dropbox spezifische Fehlerbehandlung
                            if (response.status === 409) { // Konfliktfehler (z.B. Datei nicht gefunden)
                                return response.json().then(errorData => {
                                    if (errorData?.error?.['.tag'] === 'path') {
                                        const errorTag = errorData.error.path['.tag'];
                                         if (errorTag === 'not_found') {
                                            localStorage.setItem('access_token', ''); // Token leeren
                                            throw new Error("Ihr Account ist nicht autorisiert. Wenden Sie sich an den Admin: apotheke@leanderbrunar.net"); // Fehler werfen, um den gesamten Funktionsablauf zu stoppen
                                        } else {
                                            throw new Error('Ein Pfadfehler ist aufgetreten: ' + errorTag);
                                        }
                                    } else {
                                        throw new Error('Ein API-Fehler ist aufgetreten.');
                                    }
                                });
                            } else {
                                throw new Error('HTTP-Fehler: ' + response.status);
                            }
                        }
                        return response.blob(); // Antwort als Blob zurückgeben
                    })
                    .then(blob => {
                        // Erstelle ein File-Objekt aus dem Blob
                        const fileInput = new File([blob], 'Arzneimittel_Inventar.txt', { type: 'text/plain' });

                        // Weiterverarbeitung der Datei
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const content = e.target.result;
                            const lines = content.trim().split('\n'); // Zeilen aufräumen und aufteilen

                            const dataTable = document.getElementById('dataTable');
                            dataTable.innerHTML = ''; // Tabelle leeren

                            // Erstelle die Tabelle mit den Daten aus der .txt Datei
                            for (const line of lines) {
                                const data = line.split('; ');
                                const row = document.createElement('tr');

                                for (const item of data) {
                                    const cell = document.createElement('td');
                                    cell.textContent = item;
                                    row.appendChild(cell);
                                }

                                dataTable.appendChild(row);
                            }
                        };

                        // Datei lesen
                        reader.readAsText(fileInput);
                        console.log("Daten erfolgreich von der Cloud importiert");
                    })
                    .catch(error => {
                        console.error('Fehler beim Herunterladen der Datei: ', error.message);
                        alert('Fehler: ' + error.message);
                    });
                }
            })
            .catch(error => {
                alert("Fehler beim Überprüfen des Tokens. Bitte versuchen Sie es später.");
            });
    }
}




function importTextFileExtern() {
    // Holen Sie das Datei-Eingabefeld
    const fileInput = document.getElementById('fileInput');

    // Öffnen Sie den Datei-Explorer, um eine Datei auszuwählen
    fileInput.click();

    // Event Listener, um die Datei nach Auswahl zu verarbeiten
    fileInput.addEventListener('change', function() {
        const file = fileInput.files[0];
        const dataTable = document.getElementById('dataTable');

        if (file) {
            const reader = new FileReader();

            reader.onload = function (e) {
                const content = e.target.result;
                const lines = content.trim().split('\n'); // Zeilen aufräumen und aufteilen

                // Lösche den Inhalt der Tabelle
                dataTable.innerHTML = '';

                // Erstelle den Inhalt der Tabelle mit den Daten aus der Datei
                for (const line of lines) {
                    const data = line.split('; ');
                    const row = document.createElement('tr');

                    for (const item of data) {
                        const cell = document.createElement('td');
                        cell.textContent = item;
                        row.appendChild(cell);
                    }

                    dataTable.appendChild(row);
                }
            };

            reader.readAsText(file);
            console.log("Daten erfolgreich Extern importiert");
        } else {
            showAlert("Bitte eine Textdatei auswählen.");
        }
    });

    // Verhindern Sie das Standardverhalten des Formulars
    event.preventDefault();
}



function importButton() {
    // Bestätigungsnachricht anzeigen
    const userConfirmed = confirm(
        "ACHTUNG! Durch das Importieren einer externen .txt Datei wird das Inventar von der Cloud überschrieben. \n" +
        "Über den Versionsverlauf ist die Wiederherstellung möglich. (Account benötigt die Freigabe). \n\n" +
        "Wollen Sie fortfahren?"
    );

    if (userConfirmed) {
        // Wenn der Benutzer bestätigt hat, importTextFileExtern ausführen
        importTextFileExtern();
    } else {
        // Wenn der Benutzer abgebrochen hat, nichts tun
        console.log("externer Import abgebrochen.");
    }
}


// Funktion, um Bibliothek von Dropbox herunterzuladen und im localStorage zu speichern
function importBibliothekFromCloud() {
    const accessToken = getAccessTokenFromLocalStorage(); // Den Access Token aus dem LocalStorage holen
    const dropboxFilePath = '/Apotheke/Bibliothek.xlsx';

    // API-Aufruf, um die Datei von Dropbox herunterzuladen
    fetch('https://content.dropboxapi.com/2/files/download', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + accessToken,
            'Dropbox-API-Arg': JSON.stringify({
                path: dropboxFilePath
            })
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Fehler beim Herunterladen der Bibliothek.');
        }
        return response.blob(); // Antwort als Blob zurückgeben
    })
    .then(blob => {
        // Erstelle ein FileReader-Objekt, um den Blob zu lesen
        const reader = new FileReader();

        reader.onload = function (e) {
            const content = e.target.result;
            const workbook = XLSX.read(content, { type: 'binary' });

            // Annahme: Wir nehmen das erste Arbeitsblatt
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];

            // Konvertiere das Arbeitsblatt in ein 2D-Array
            const data = XLSX.utils.sheet_to_json(sheet, { header: 1 });

            // Überschrift für die Spalten hinzufügen
            const headers = ["Barcode", "Wirkstoff", "Bezeichnung", "mind. Menge", "Lagerort"];

            // Entferne die erste Zeile und behalte nur die ersten 5 Spalten (A bis E)
            const trimmedData = data.slice(1).map(row => row.slice(0, 5));

            // Formatieren der Zahlen, um sie ohne Tausender-Trennzeichen oder Dezimalstellen anzuzeigen
            const formattedData = trimmedData.map(row => {
                return row.map(cell => {
                    if (typeof cell === 'number') {
                        return cell.toString();
                    }
                    return cell;
                });
            });

            // Füge die Überschrift hinzu
            formattedData.unshift(headers);

            // Speichere die formatierten Daten im localStorage als JSON
            localStorage.setItem('Bibliothek_Arzneimittel', JSON.stringify(formattedData));

            console.log('Bibliothek erfolgreich im localStorage gespeichert.');
        };

        // Lese den Blob als binären String
        reader.readAsBinaryString(blob);
    })
    .catch(error => {
        console.error('Fehler:', error);
    });
}




let timerId = null; // Speichert die ID des Timers

// Startet den Timer
function startExportTimer() {
    stopExportTimer(); // Stellt sicher, dass kein alter Timer läuft
    timerId = setInterval(() => {
        exportTextFileToCloud(); // Führt die Export-Funktion aus
    }, 60000); // 60000 ms = 1 Minute
    console.log("Timer gestartet. Die Speicherung wird alle 60 Sekunden ausgeführt.");
}

// Stoppt den Timer
function stopExportTimer() {
    if (timerId !== null) {
        clearInterval(timerId); // Beendet den aktuellen Timer
        timerId = null; // Zurücksetzen der Timer-ID
        console.log("Timer gestoppt. Es erfolgt keine automatische Speicherung.");
    }
}





function exportTextFileToCloud() {
    const accessToken = getAccessTokenFromLocalStorage();  // Den Access Token aus dem LocalStorage holen
    const dropboxFilePath = '/Apotheke/Arzneimittel/Arzneimittel_Inventar.txt';

    if (!accessToken) {
        exportTextFiletoExtern();
        const now = new Date();
        const timestamp = now.toLocaleString('de-DE', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
        }).replace(/[^0-9]/g, '_');
        const fileName = `Arzneimittel_${timestamp}.txt`;

        const userConfirmed = confirm(
            `Kein Access Token gefunden. \n` +
            `Die Datei wurde in den Downloads gespeichert: ${fileName} \n\n` +
            `Melden Sie sich an und importieren Sie anschließend die Datei über 'Importieren'`
        );

        if (userConfirmed) {
            // Umleitung, wenn der Benutzer auf "OK" klickt
            window.location.href = '../login.html';
        }
    } else {
        // Token Überprüfung

        checkTokenValidity(accessToken)
            .then(isValid => {
                if (!isValid) {
                    // Token ungültig

                    exportTextFiletoExtern();
                    const now = new Date();
                    const timestamp = now.toLocaleString('de-DE', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                    }).replace(/[^0-9]/g, '_');
                    const fileName = `Arzneimittel_${timestamp}.txt`;

                    const userConfirmed = confirm(
                        `Der Access Token ist ungültig. \n` +
                        `Die Datei wurde in den Downloads gespeichert: ${fileName} \n\n` +
                        `Melden Sie sich erneut an und importieren Sie anschließend die Datei über 'Importieren'`
                    );

                    if (userConfirmed) {
                        // Umleitung, wenn der Benutzer auf "OK" klickt
                        window.location.href = '../login.html';
                    }
                } else {
                    // Token gültig
                    console.log("Token gültig: " + accessToken);

                    const dataTable = document.getElementById('dataTable');
                    const rows = dataTable.getElementsByTagName('tr');
                    let content = '';

                    for (const row of rows) {
                        const cells = row.getElementsByTagName('td');
                        const rowData = [];
                        for (const cell of cells) {
                            rowData.push(cell.textContent);
                        }
                        content += rowData.join('; ') + '\n';
                    }

                    // Erstellen eines Blob-Objekts für den Dateiinhalt
                    const blob = new Blob([content], { type: 'text/plain' });

                    // API-Aufruf, um die Datei auf Dropbox hochzuladen
                    fetch('https://content.dropboxapi.com/2/files/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + accessToken,
                            'Dropbox-API-Arg': JSON.stringify({
                                path: dropboxFilePath,
                                mode: 'overwrite',
                                autorename: true,
                                mute: false
                            }),
                            'Content-Type': 'application/octet-stream'
                        },
                        body: blob
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Fehler beim Hochladen der Datei.');
                        }
                        return response.json();
                    })
                    .then(data => {
                    showAlert("Datei erfolgreich hochgeladen!");
                    hideUnsavedWarning();
                    })
                    .catch(error => {
                        console.error('Fehler beim Hochladen der Datei: ', error);
                        alert('Fehler beim Hochladen der Datei. Bitte versuchen Sie es erneut.');
                    });
                }
            })

    }

}







function exportTextFiletoExtern() {
    const dataTable = document.getElementById('dataTable');
    const rows = dataTable.getElementsByTagName('tr');
    let content = '';

    for (const row of rows) {
        const cells = row.getElementsByTagName('td');
        const rowData = [];
        for (const cell of cells) {
            rowData.push(cell.textContent);
        }
        content += rowData.join('; ') + '\n';
    }

    // Dateinamen mit dem aktuellen Datum und Uhrzeit erstellen
    const now = new Date();
    const timestamp = now.toLocaleString('de-DE', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
    }).replace(/[^0-9]/g, '_');

    const fileName = `Arzneimittel_${timestamp}.txt`;

    // Erstellen eines Blob-Objekts für den Dateiinhalt
    const blob = new Blob([content], { type: 'text/plain' });

    // Erstellen eines Download-Links und Klicken auf den Link
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

}


function exportButton() {
    exportTextFiletoExtern();
event.preventDefault();
}

function saveButton() {
    event.preventDefault();
    exportTextFileToCloud();

}


function refreshTable() {
    const dataTable = document.getElementById('dataTable');
    const rows = dataTable.getElementsByTagName('tr');

    const uniqueRows = new Map();

    // Ermitteln von x (letzte zwei Ziffern des aktuellen Jahres) und y (aktuelle Monatszahl)
    const today = new Date();
    const x = today.getFullYear() % 100;
    const y = today.getMonth() + 2; // Beachten Sie, dass die Monate von 0 (Januar) bis 11 (Dezember) nummeriert sind

    // Durchlaufen Sie die Zeilen der Tabelle
    for (const row of rows) {
        const cells = row.getElementsByTagName('td');
        const key = cells[0].textContent + cells[2].textContent;

        // Ermitteln von z (zweistellige Zahl nach dem / in Spalte 3) und der ersten zweistelligen Zahl vor dem /
        const z = parseInt(cells[2].textContent.split('/')[1], 10);
        const firstNumber = parseInt(cells[2].textContent.split('/')[0], 10);

        if (uniqueRows.has(key)) {
            // Eine Zeile mit dem gleichen Schlüssel wurde bereits gefunden
            // Extrahiere den Wert der zweiten Spalte
            const currentValue = uniqueRows.get(key).getElementsByTagName('td')[1].textContent;
            const newValue = cells[1].textContent;

            // Extrahiere die Zahlen aus den Werten und aktualisiere sie
            const currentNumber = parseNumber(currentValue);
            const newNumber = parseNumber(newValue);
            const totalNumber = currentNumber + newNumber;

            // Setze den Text in der zweiten Spalte auf die aktualisierte Summe
            uniqueRows.get(key).getElementsByTagName('td')[1].textContent = formatValue(totalNumber, currentValue);
        } else {
            // Fügen Sie die Zeile als eindeutige Zeile hinzu
            uniqueRows.set(key, row);
        }
    }

    // Löschen Sie den Inhalt der Tabelle
    dataTable.innerHTML = '';

    // Fügen Sie die eindeutigen Zeilen zurück in die Tabelle ein
    for (const row of uniqueRows.values()) {
        dataTable.appendChild(row);
    }

    // Sortieren Sie die Tabelle nach den gewünschten Prioritäten
    const sortedRows = Array.from(dataTable.getElementsByTagName('tr')).sort((a, b) => {
        const keyA = a.cells[2].textContent.split('/')[1]; // Zweistellige Zahl nach dem /
        const keyB = b.cells[2].textContent.split('/')[1];

        if (keyA !== keyB) {
            return parseInt(keyA, 10) - parseInt(keyB, 10);
        }

        const firstNumberA = parseInt(a.cells[2].textContent.split('/')[0], 10); // Erste zweistellige Zahl vor dem /
        const firstNumberB = parseInt(b.cells[2].textContent.split('/')[0], 10);

        if (firstNumberA !== firstNumberB) {
            return firstNumberA - firstNumberB;
        }

        return a.cells[3].textContent.localeCompare(b.cells[3].textContent); // Alphabetische Sortierung in Spalte 4
    });

    // Löschen Sie den Inhalt der Tabelle und fügen Sie die sortierten Zeilen zurück ein
    dataTable.innerHTML = '';
    for (const row of sortedRows) {
        dataTable.appendChild(row);
    }

    // Nach dem Sortieren: Färben Sie die Zeilen rot
    for (const row of dataTable.getElementsByTagName('tr')) {
        const cells = row.getElementsByTagName('td');
        const z = parseInt(cells[2].textContent.split('/')[1], 10);
        const firstNumber = parseInt(cells[2].textContent.split('/')[0], 10);

     if ((z <= x && firstNumber <= y) || z < x) {
         row.style.backgroundColor = 'red';
      } else {
         row.style.backgroundColor = 'white';
      }

    }

    // Entfernen von Zeilen mit Menge = 0
    const allRows = Array.from(dataTable.getElementsByTagName('tr'));
    for (const row of allRows) {
        const cells = row.getElementsByTagName('td');
        if (parseInt(cells[1].textContent, 10) === 0) {
            dataTable.removeChild(row);
        }
    }

    showUnsavedWarning();
    sortTableBynegative();
event.preventDefault();

}

// Hilfsfunktion zum Extrahieren und Verarbeiten von Werten
function parseNumber(text) {
    const match = text.match(/(-?\d+).*|(-?\d+\s*[^\d]*)/); // Sucht nach einer Zahl mit optionaler Vorzeichen (-) und optionalen Zeichen am Ende
    if (match) {
        return parseInt(match[1], 10) || 0; // Gibt die gefundene Zahl als Ganzzahl zurück, oder 0, wenn keine Zahl gefunden wurde
    }
    return 0; // Wenn keine Zahl gefunden wurde, wird 0 zurückgegeben
}

// Hilfsfunktion zum Formatieren von Werten als Text
function formatValue(number, originalValue) {
    if (originalValue.includes(" ")) {
        // Wenn der ursprüngliche Wert Leerzeichen enthält, füge die Einheiten beibehalten
        return number + " " + originalValue.split(" ")[1];
    }
    return number.toString(); // Andernfalls gibt die Zahl als Text zurück
}




// Funktion zum Sortieren der Zeilen mit negativen Werten in Spalte 2 und Färben
function sortTableBynegative() {
    var table = document.getElementById("dataTable");
    var rows = Array.from(table.rows);

    // Sortiere die Zeilen, sodass die Zeilen mit negativen Werten in Spalte 2 ganz oben stehen
    rows.sort(function(a, b) {
        // Vergleiche die Werte in Spalte 2 (Menge)
        var valueA = parseFloat(a.cells[1].textContent.trim());
        var valueB = parseFloat(b.cells[1].textContent.trim());

        // Zeilen mit negativen Werten sollen nach oben
        return valueA < 0 && valueB >= 0 ? -1 :
               valueA >= 0 && valueB < 0 ? 1 : 0;
    });

    // Entferne bestehende Zeilen aus der Tabelle
    for (var i = 0; i < rows.length; i++) {
        table.appendChild(rows[i]);
    }

    // Färbe Zeilen mit negativen Werten in Spalte 2 gelb
    for (var i = 0; i < rows.length; i++) {
        var row = rows[i];
        var value = parseFloat(row.cells[1].textContent.trim());

        // Wenn der Wert in Spalte 2 negativ ist, färbe die Zeile gelb
        if (value < 0) {
            row.style.backgroundColor = 'yellow';
        }
    }
}





function sortTableByWirkstoff() {
    const dataTable = document.getElementById('dataTable');
    const rows = Array.from(dataTable.getElementsByTagName('tr'));

    rows.sort((a, b) => {
        const wirkstoffA = a.cells[3].textContent;
        const wirkstoffB = b.cells[3].textContent;
        return wirkstoffA.localeCompare(wirkstoffB);
    });

    dataTable.innerHTML = ''; // Tabelle leeren

    for (const row of rows) {
        dataTable.appendChild(row);
    }
event.preventDefault();
}

function search() {
    // Prüfe, ob im Textfeld "Barcode" etwas steht
    var barcodeInput = document.querySelector('input[placeholder="Barcode"]').value.trim();
    if (barcodeInput) {
        // Code 1: Suche nach Barcode
        searchByBarcode(barcodeInput);
        return;
    }

    // Prüfe, ob im Textfeld "Wirkstoff" etwas steht
    var wirkstoffInput = document.querySelector('input[placeholder="Wirkstoff"]').value.trim();
    if (wirkstoffInput) {
        // Code 2: Suche nach Wirkstoff
        searchByWirkstoff(wirkstoffInput);
        return;
    }

    // Prüfe, ob im Textfeld "Bezeichnung" etwas steht
    var BezeichnungInput = document.querySelector('input[placeholder="Bezeichnung"]').value.trim();
    if (BezeichnungInput) {
        // Code 3: Suche nach Bezeichnung
        searchByBezeichnung(BezeichnungInput);
        return;
    }

    // Wenn keines der Textfelder ausgefüllt ist, hier kannst du optionalen Code hinzufügen.
    // Dieser wird ausgeführt, wenn keines der Textfelder etwas enthält.

    showAlert("Bitte Suchbegriff eingeben.");
event.preventDefault();
}

function searchByBarcode(barcode) {
    // Extrahiere die Daten aus dem localStorage
    const storedData = localStorage.getItem('Bibliothek_Arzneimittel');
    let found = false;

    if (storedData) {
        const bibliothek = JSON.parse(storedData);

        // Suche nach dem Barcode in der JSON-Struktur
        bibliothek.forEach(item => {
            const barcodeValue = item[0]; // Spalte 1: Barcode
            const wirkstoffValue = item[1]; // Spalte 2: Wirkstoff
            const bezeichnungValue = item[2]; // Spalte 3: Bezeichnung

            if (barcodeValue === barcode) {
                // Barcode wurde gefunden
                document.querySelector('input[placeholder="Wirkstoff"]').value = wirkstoffValue;
                document.querySelector('input[placeholder="Bezeichnung"]').value = bezeichnungValue;

                found = true;
            }
        });
    }

    if (!found) {
        showAlert("Neues Produkt!");
    }
}


function searchByWirkstoff(wirkstoff) {
    // Textfeld "Wirkstoff" auslesen
    const wirkstoffInput = wirkstoff.trim().toLowerCase();

    // Textfelder "Barcode" und "Bezeichnung" leeren
    document.querySelector('input[placeholder="Barcode"]').value = '';
    document.querySelector('input[placeholder="Bezeichnung"]').value = '';

    // Extrahiere die Daten aus dem localStorage
    const storedData = localStorage.getItem('Bibliothek_Arzneimittel');
    let found = false;

    if (storedData) {
        const bibliothek = JSON.parse(storedData);

        // Suche nach dem Wirkstoff in der JSON-Struktur
        bibliothek.forEach(item => {
            const wirkstoffValue = item[1].trim().toLowerCase(); // Spalte 2: Wirkstoff
            const barcodeValue = item[0]; // Spalte 1: Barcode
            const bezeichnungValue = item[2]; // Spalte 3: Bezeichnung

            if (wirkstoffValue === wirkstoffInput) {
                // Wirkstoff wurde gefunden
                document.querySelector('input[placeholder="Barcode"]').value = barcodeValue;
                document.querySelector('input[placeholder="Bezeichnung"]').value = bezeichnungValue;

                found = true;
            }
        });
    }

    // Meldung, wenn Begriff nicht gefunden wurde
    if (!found) {
        showAlert("Neues Produkt!");
    }
}


function searchByBezeichnung(Bezeichnung) {
    // Textfeld "Bezeichnung" auslesen
    var BezeichnungInput = document.querySelector('input[placeholder="Bezeichnung"]').value.trim().toLowerCase();

    // Textfelder "Barcode" und "Wirkstoff" leeren
    document.querySelector('input[placeholder="Barcode"]').value = '';
    document.querySelector('input[placeholder="Wirkstoff"]').value = '';

    // Daten aus dem localStorage laden
    const storedData = localStorage.getItem('Bibliothek_Arzneimittel');
    var found = false;

    if (storedData) {
        const bibliothek = JSON.parse(storedData);

        // JSON-Daten durchsuchen
        bibliothek.forEach(item => {
            // Sicherstellen, dass item[2] existiert und keine Fehler verursacht
            var cellValue = item[2] ? item[2].trim().toLowerCase() : '';

            if (cellValue === BezeichnungInput) {
                // Begriff wurde in Spalte 3 gefunden
                var barcodeValue = item[0] || ''; // Spalte 1: Barcode
                var wirkstoffValue = item[1] || ''; // Spalte 2: Wirkstoff

                // Setze die gefundenen Werte in die Textfelder "Barcode" und "Wirkstoff"
                document.querySelector('input[placeholder="Barcode"]').value = barcodeValue;
                document.querySelector('input[placeholder="Wirkstoff"]').value = wirkstoffValue;

                found = true;
            }
        });
    }

    // Meldung, wenn Begriff nicht gefunden wurde
    if (!found) {
        showAlert("Neues Produkt!");
    }
}



function addNewEntry() {
    // Zugriff auf die Textfelder
    const barcodeInput = document.querySelector('input[placeholder="Barcode"]');
    const mengeInput = document.querySelector('input[placeholder="Menge"]');
    const ablaufdatumInput = document.querySelector('input[placeholder="Ablaufdatum"]');
    const wirkstoffInput = document.querySelector('input[placeholder="Wirkstoff"]');
    const BezeichnungInput = document.querySelector('input[placeholder="Bezeichnung"]');

    // Überprüfen, ob alle Felder ausgefüllt sind
    if (
        barcodeInput.value === '' ||
        mengeInput.value === '' ||
        ablaufdatumInput.value === '' ||
        wirkstoffInput.value === '' ||
        BezeichnungInput.value === ''
    ) {
        showAlert("Alle Felder ausfüllen!");
        return;
    }

    // Zugriff auf die Tabelle
    const table = document.getElementById('dataTable');

    // Neue Zeile erstellen
    const newRow = table.insertRow(0);

    // Neue Zellen für die Zeile erstellen und Werte aus den Textfeldern einfügen
    const cell1 = newRow.insertCell(0);
    cell1.innerHTML = barcodeInput.value;

    const cell2 = newRow.insertCell(1);
    cell2.innerHTML = mengeInput.value;

    const cell3 = newRow.insertCell(2);
    cell3.innerHTML = ablaufdatumInput.value;

    const cell4 = newRow.insertCell(3);
    cell4.innerHTML = wirkstoffInput.value;

    const cell5 = newRow.insertCell(4);
    cell5.innerHTML = BezeichnungInput.value;

    // Textfelder leeren
    barcodeInput.value = '';
    mengeInput.value = '';
    ablaufdatumInput.value = '';
    wirkstoffInput.value = '';
    BezeichnungInput.value = '';

    // Fokus auf das Barcode-Textfeld legen
    barcodeInput.focus();
showUnsavedWarning();
event.preventDefault();
}

// Diese Funktion überprüft, ob Daten in der Tabelle vorhanden sind.
function isTableNotEmpty() {
    const table = document.getElementById('dataTable');
    // Überprüfe, ob es Zeilen (abgesehen von der Header-Zeile) in der Tabelle gibt.
    return table.rows.length > 1;
}

// Diese Funktion zeigt die Warnung, wenn die Tabelle nicht gespeichert ist.
function showUnsavedWarning() {
    const unsavedWarning = document.getElementById('unsavedWarning');
    if (isTableNotEmpty()) {
        unsavedWarning.style.display = 'inline';
    } else {
        unsavedWarning.style.display = 'none';
    }
}

// Diese Funktion entfernt die Warnung, indem sie das Element ausblendet.
function hideUnsavedWarning() {
    const unsavedWarning = document.getElementById('unsavedWarning');
    if (unsavedWarning) {
        unsavedWarning.style.display = 'none';
    }
}


// Funktion zum Öffnen des README-Popups und Laden der Inhalte
function openReadmePopup() {
    const popup = document.getElementById('readmePopup');
    const contentDiv = document.getElementById('readmeContent');

    // Inhalte der externen HTML-Datei laden
    fetch('../readme.html')
        .then(response => {
            if (!response.ok) {
                throw new Error('Fehler beim Laden der README-Datei.');
            }
            return response.text();
        })
        .then(html => {
            contentDiv.innerHTML = html;
            popup.style.display = 'block'; // Popup sichtbar machen
        })
        .catch(error => {
            contentDiv.innerHTML = `<p style="color: red;">Fehler: ${error.message}</p>`;
        });
}

// Funktion zum Schließen des README-Popups
function closeReadmePopup() {
    const popup = document.getElementById('readmePopup');
    popup.style.display = 'none';
}




// Funktion zum Aktivieren/Deaktivieren der Buttons
function toggleButtonsOnSwitch() {
    const editToggle = document.getElementById("editToggle");
    const buttons = document.querySelectorAll("button"); // Alle Buttons auswählen

    buttons.forEach(function(button) {
        if (editToggle.checked) {
            // Wenn der Switch "On" ist, deaktiviere alle Buttons außer dem Switch selbst
            if (button !== editToggle) {
                button.disabled = true;
                button.classList.add("disabled-button"); // Füge eine CSS-Klasse hinzu, um den Button zu verblassen
            }
        } else {
            // Wenn der Switch "Off" ist, aktiviere alle Buttons
            button.disabled = false;
            button.classList.remove("disabled-button"); // Entferne die CSS-Klasse, um den Button zu reaktivieren
        }
    });
}


// Event-Listener für den Switch-Zustand
const editToggle = document.getElementById("editToggle");
editToggle.addEventListener("change", function() {
    toggleButtonsOnSwitch(); // Aktualisiere die Button-Zustände beim Umschalten des Switches
});

// Funktion zum Bearbeiten der Tabelle
function toggleTableEditing() {
    const editToggle = document.getElementById("editToggle");
    const table = document.getElementById("dataTable");

    if (editToggle.checked) {
        table.contentEditable = true;
        table.classList.add("editable"); // Füge eine CSS-Klasse für bearbeitbare Tabellen hinzu
        stopExportTimer();
        showUnsavedWarning();
        console.log("Die Tabelle kann bearbeitet werden.");
    } else {
        table.contentEditable = false;
        table.classList.remove("editable"); // Entferne die CSS-Klasse, um die Tabelle nicht bearbeitbar zu machen
        console.log("Die Bearbeitung der Tabelle ist abgeschlossen.");
        exportTextFileToCloud();
        startExportTimer();
    }
}

// Event-Listener für die Bearbeitbarkeit der Tabelle
editToggle.addEventListener("change", toggleTableEditing);


function showAlert(message) {
    const alertBox = document.createElement("div");
    alertBox.textContent = message;
    alertBox.style.backgroundColor = "yellow";
    alertBox.style.padding = "10px";
    alertBox.style.borderRadius = "5px";
    alertBox.style.color = "red";
    alertBox.style.position = "fixed";
    alertBox.style.top = "20px";
    alertBox.style.left = "20px";
    alertBox.style.zIndex = "1000";

    document.body.appendChild(alertBox);

    setTimeout(() => {
        alertBox.style.display = "none";
    }, 2500); // Verstecke die Benachrichtigung nach 2,5 Sekunden
}


function openComparisonTable() {
    const tableA = document.getElementById('dataTable');
    const tableB = document.getElementById('tableB');

    // Kopiere die Tabelle von Formular 1 zu Formular 2
    tableB.innerHTML = tableA.innerHTML;

    // Rufe die Funktion zum Zusammenfassen und Löschen auf
    mergeAndClearTable(tableB);

    // Setze den Hintergrund aller Zeilen in Tabelle B auf weiß
    const rowsB = tableB.getElementsByTagName('tr');
    for (const row of rowsB) {
        row.style.backgroundColor = 'white';
    }


    // Zeige Formular 2
    document.getElementById('form1').style.display = 'none';
    document.getElementById('form2').style.display = 'block';

    event.preventDefault();
}


// Funktion zum Zusammenfassen der Tabelle und Löschen von Spalte 3
function mergeAndClearTable(table) {
    const rows = table.getElementsByTagName('tr');
    const mergedRows = new Map();

    for (const row of rows) {
        const cells = row.getElementsByTagName('td');
        if (cells.length >= 2) {
            const key = cells[0].textContent;

            if (mergedRows.has(key)) {
                // Eine Zeile mit dem gleichen Schlüssel wurde bereits gefunden
                const currentValue = parseNumber(cells[1].textContent);
                const newValue = parseNumber(mergedRows.get(key).getElementsByTagName('td')[1].textContent);
                const totalValue = currentValue + newValue;

                // Aktualisiere die Zellen in Spalte 2
                mergedRows.get(key).getElementsByTagName('td')[1].textContent = formatValue(totalValue, cells[1].textContent);
            } else {
                // Füge die Zeile als eindeutige Zeile hinzu
                mergedRows.set(key, row);
            }

            // Lösche die Werte in Spalte 3
            cells[2].textContent = '';
        }
    }

    // Lösche den Inhalt der Tabelle und füge die zusammengefassten Zeilen zurück ein
    table.innerHTML = '';
    for (const row of mergedRows.values()) {
        table.appendChild(row);
    }
}


// Kehrt von Formular 2 zu Formular 1 zurück.
function returnToForm1() {
            const form1 = document.getElementById('form1');
            const form2 = document.getElementById('form2');
            const tableB = document.getElementById('tableB');
            const tableC = document.getElementById('tableC');
            const tableD = document.getElementById('tableD');

         // Leeren Sie den Inhalt von Tabelle B, indem Sie den innerHTML-Wert auf einen leeren String setzen
         tableB.innerHTML = '';
         tableC.innerHTML = '';
         tableD.innerHTML = '';

            form2.style.display = 'none'; // Verstecke Formular 2
            form1.style.display = 'block'; // Zeige Formular 1
           
           event.preventDefault();
}


// Funktion, um Daten aus dem localStorage zu laden und in TableC darzustellen
function compareAndDisplay() {
    const tableC = document.getElementById('tableC');

    // Daten aus dem localStorage abrufen
    const storedData = localStorage.getItem('Bibliothek_Arzneimittel');

    if (!storedData) {
        alert("Keine Bibliothek gefunden. Bitte laden Sie die Seite neu.");
        return;
    }

    // JSON-Daten parsen
    const parsedData = JSON.parse(storedData);

    // Entferne die Überschrift (Zeile 0)
    const dataWithoutHeaders = parsedData.slice(1);

    // Tabelle leeren
    tableC.innerHTML = '';

    // Daten in die Tabelle einfügen
    dataWithoutHeaders.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell;
            tr.appendChild(td);
        });
        tableC.appendChild(tr);
    });

    // Tabelle verstecken
    tableC.style.display = 'none';

    // Weitere Funktionen aufrufen, falls nötig
    sortByWirkstoffTableB();
    compareTables();
    displayMissingRows();

event.preventDefault();

}







function compareTables() {
  const tableB = document.getElementById("tableB");
  const tableC = document.getElementById("tableC");

  const rowsB = tableB.getElementsByTagName("tr");
  const rowsC = tableC.getElementsByTagName("tr");

  for (let i = 0; i < rowsB.length; i++) {
    const cellsB = rowsB[i].getElementsByTagName("td");

    // Wert in Spalte 2 von Table B
    const valueInColumn2 = parseInt(cellsB[1].textContent, 10);
    // Wert in Spalte 3 von Table B
    const valueInColumn3 = parseInt(cellsB[2].textContent, 10);

    // Durchsuchen von Table C nach dem Wert in Spalte 1
    for (let j = 0; j < rowsC.length; j++) {
      const cellsC = rowsC[j].getElementsByTagName("td");
      if (cellsC[0].textContent === cellsB[0].textContent) {
        // Wert in Spalte 4 von Table C
        const valueFromTableC = cellsC[3].textContent;

        // Einfügen des Werts in Spalte 3 von Table B
        cellsB[2].textContent = valueFromTableC;

        // Brechen Sie die Schleife, wenn eine Übereinstimmung gefunden wurde
        break;
      }
    }
  }

  // Jetzt, nachdem alle Werte in Spalte 3 aktualisiert wurden, färben Sie die Zeilen
  for (let i = 0; i < rowsB.length; i++) {
    const cellsB = rowsB[i].getElementsByTagName("td");

    // Wert in Spalte 2 von Table B
    const valueInColumn2 = parseInt(cellsB[1].textContent, 10);
    // Wert in Spalte 3 von Table B
    const valueInColumn3 = parseInt(cellsB[2].textContent, 10);

    // Färben Sie die Zeile orange, wenn Spalte 2 kleiner oder gleich Spalte 3 ist oder wenn Spalte 3 leer ist
    if (valueInColumn2 <= valueInColumn3 || isNaN(valueInColumn3)) {
      rowsB[i].style.backgroundColor = "orange";
    }
  }

displayMissingRows();

  event.preventDefault();
}


function displayMissingRows() {
    const tableB = document.getElementById("tableB");
    const tableC = document.getElementById("tableC");
    const tableD = document.getElementById("tableD");

    const rowsB = tableB.getElementsByTagName("tr");
    const rowsC = tableC.getElementsByTagName("tr");

    // Verstecke TableD während des Vergleichs und mache es immer orange
    tableD.style.display = 'none';
    tableD.style.backgroundColor = 'orange';

    // Sammle die Zeilen, die in TableC stehen, aber nicht in TableB
    const missingRows = [];

    for (let i = 0; i < rowsC.length; i++) {
        const cellsC = rowsC[i].getElementsByTagName("td");
        const valueInColumn1C = cellsC[0].textContent;

        let found = false;
        for (let j = 0; j < rowsB.length; j++) {
            const cellsB = rowsB[j].getElementsByTagName("td");
            const valueInColumn1B = cellsB[0].textContent;

            if (valueInColumn1C === valueInColumn1B) {
                found = true;
                break;
            }
        }

        if (!found) {
            missingRows.push(rowsC[i].outerHTML);
        }
    }

    // Füge die fehlenden Zeilen in TableD ein
    tableD.innerHTML = missingRows.join("");

    // Zeige TableD an
    tableD.style.display = 'block';
}


function sortByWirkstoffTableB() {
    const tableB = document.getElementById('tableB');
    const rows = Array.from(tableB.getElementsByTagName('tr'));

    rows.sort((a, b) => {
        const wirkstoffA = a.cells[3].textContent;
        const wirkstoffB = b.cells[3].textContent;
        return wirkstoffA.localeCompare(wirkstoffB);
    });

    tableB.innerHTML = ''; // Tabelle leeren

    for (const row of rows) {
        tableB.appendChild(row);
    }
}

document.addEventListener('DOMContentLoaded', function () {
    let selectedIndex = 0; // Index des aktuell anvisierten Elements

    // Extrahiere die Wirkstoffdaten aus dem localStorage
    const extractWirkstoffDataFromLocalStorage = () => {
        const wirkstoffData = [];
        const storedData = localStorage.getItem('Bibliothek_Arzneimittel');

        if (storedData) {
            const bibliothek = JSON.parse(storedData);
            bibliothek.forEach((item, index) => {
                if (index === 0) return; // Überspringe die erste Zeile
                const wirkstoff = item[1]; // Spalte 2 enthält den Wirkstoff
                if (wirkstoff && wirkstoff !== '') {
                    wirkstoffData.push(wirkstoff);
                }
            });
        }
        return wirkstoffData;
    };

    const wirkstoffInput = document.querySelector('input[placeholder="Wirkstoff"]');
    const unsavedWarning = document.getElementById('unsavedWarning');

    // Aktiviere die Autocomplete-Funktion für das Wirkstoff-Textfeld.
    wirkstoffInput.addEventListener('input', function () {
        const inputText = this.value.toLowerCase();
        const wirkstoffData = extractWirkstoffDataFromLocalStorage();
        const filteredData = wirkstoffData.filter(wirkstoff => wirkstoff.toLowerCase().includes(inputText));
        createAutocompleteDropdown(filteredData);
        selectedIndex = 0; // Setze den Index auf das oberste Element zurück, wenn sich der Text ändert
        highlightSelectedItem(); // Hervorhebe standardmäßig das oberste Ergebnis
    });

    // Erzeuge das Dropdown-Menü für die Autocomplete-Funktion.
    const createAutocompleteDropdown = (data) => {
        closeAutocompleteDropdown(); // Schließe vorhandene Dropdown-Menüs

        if (data.length === 0) {
            return;
        }

        const maxRows = 6; // Maximal 6 Zeilen
        const dropdownContainer = document.createElement('div');
        dropdownContainer.classList.add('autocomplete-dropdown');

        const inputRect = wirkstoffInput.getBoundingClientRect();
        dropdownContainer.style.position = 'absolute';
        dropdownContainer.style.top = inputRect.bottom + 'px';
        dropdownContainer.style.left = inputRect.left + 'px';
        dropdownContainer.style.width = wirkstoffInput.offsetWidth + 'px';
        dropdownContainer.style.backgroundColor = '#fff'; // Hintergrundfarbe
        dropdownContainer.style.border = '1px solid #ccc'; // Rahmen
        dropdownContainer.style.overflowY = data.length > maxRows ? 'scroll' : 'auto'; // Füge einen Scrollbalken hinzu, wenn mehr als 6 Zeilen vorhanden sind
        dropdownContainer.style.maxHeight = `${maxRows * 20}px`; // Höhe für maximal 6 Zeilen (Annahme: 20px pro Zeile)

        // Verwende ein Set, um eindeutige Werte zu speichern
        const uniqueData = new Set(data);

        uniqueData.forEach((item, index) => {
            const itemElement = document.createElement('div');
            itemElement.classList.add('autocomplete-item');
            itemElement.textContent = item;
            itemElement.addEventListener('click', function () {
                wirkstoffInput.value = item;
                closeAutocompleteDropdown();
            });
            itemElement.addEventListener('mouseenter', function () {
                selectedIndex = index;
                highlightSelectedItem();
            });
            dropdownContainer.appendChild(itemElement);
        });

        document.body.appendChild(dropdownContainer);

        // Füge die CSS-Regel für den Cursor hinzu
        const autocompleteItems = document.querySelectorAll('.autocomplete-item');
        autocompleteItems.forEach(item => {
            item.style.cursor = 'pointer';
        });

        // Füge Event Listener für Pfeiltasten und Enter hinzu
        document.addEventListener('keydown', handleKeyDown);
    };

    // Schließe das Dropdown-Menü der Autocomplete-Funktion.
    const closeAutocompleteDropdown = () => {
        const dropdown = document.querySelector('.autocomplete-dropdown');
        if (dropdown) {
            dropdown.remove();
            document.removeEventListener('keydown', handleKeyDown); // Entferne Event Listener beim Schließen
        }
    };

    // Schließe das Dropdown-Menü beim Klicken außerhalb des Textfelds.
    document.addEventListener('click', function (event) {
        if (!event.target.classList.contains('autocomplete-item') && !event.target.matches('input[placeholder="Wirkstoff"]')) {
            closeAutocompleteDropdown();
        }
    });

    // Hervorhebung des aktuell anvisierten Elements
    const highlightSelectedItem = () => {
        const autocompleteItems = document.querySelectorAll('.autocomplete-item');
        autocompleteItems.forEach((item, index) => {
            if (index === selectedIndex) {
                item.style.backgroundColor = '#f0f0f0'; // Hintergrundfarbe für Anvisierung
            } else {
                item.style.backgroundColor = ''; // Zurücksetzen der Hintergrundfarbe für andere Elemente
            }
        });
    };

    // Behandlung der Tastenereignisse
    const handleKeyDown = (event) => {
        const autocompleteItems = document.querySelectorAll('.autocomplete-item');

        if (event.key === 'ArrowUp' && selectedIndex > 0) {
            selectedIndex--;
        } else if (event.key === 'ArrowDown' && selectedIndex < autocompleteItems.length - 1) {
            selectedIndex++;
        } else if (event.key === 'Enter' && selectedIndex !== -1) {
            const selectedItem = autocompleteItems[selectedIndex];
            if (selectedItem) {
                wirkstoffInput.value = selectedItem.textContent;
                closeAutocompleteDropdown();
            }
        }

        highlightSelectedItem();
    };
});




document.addEventListener('DOMContentLoaded', function () {
    let selectedIndex = 0; // Index des aktuell anvisierten Elements

    // Extrahiere die Bezeichnungdaten aus dem localStorage
    const extractBezeichnungDataFromLocalStorage = () => {
        const bezeichnungData = [];
        const storedData = localStorage.getItem('Bibliothek_Arzneimittel');

        if (storedData) {
            const bibliothek = JSON.parse(storedData);
            bibliothek.forEach((item, index) => {
                if (index === 0) return; // Überspringe die erste Zeile
                const bezeichnung = item[2]; // Spalte 3 enthält die Bezeichnung
                if (bezeichnung && bezeichnung !== '') {
                    bezeichnungData.push(bezeichnung);
                }
            });
        }
        return bezeichnungData;
    };


    const bezeichnungInput = document.querySelector('input[placeholder="Bezeichnung"]');
    const unsavedWarning = document.getElementById('unsavedWarning');

    // Aktiviere die Autocomplete-Funktion für das Bezeichnung-Textfeld.
    bezeichnungInput.addEventListener('input', function () {
        const inputText = this.value.toLowerCase();
        const bezeichnungData = extractBezeichnungDataFromLocalStorage();
        const filteredData = bezeichnungData.filter(bezeichnung => bezeichnung.toLowerCase().includes(inputText));
        createAutocompleteDropdown(filteredData);
        selectedIndex = 0; // Setze den Index auf das oberste Element zurück, wenn sich der Text ändert
        highlightSelectedItem(); // Hervorhebe standardmäßig das oberste Ergebnis
    });

    // Erzeuge das Dropdown-Menü für die Autocomplete-Funktion.
    const createAutocompleteDropdown = (data) => {
        closeAutocompleteDropdown(); // Schließe vorhandene Dropdown-Menüs

        if (data.length === 0) {
            return;
        }

        const maxRows = 6; // Maximal 6 Zeilen
        const dropdownContainer = document.createElement('div');
        dropdownContainer.classList.add('autocomplete-dropdown');

        const inputRect = bezeichnungInput.getBoundingClientRect();
        dropdownContainer.style.position = 'absolute';
        dropdownContainer.style.top = inputRect.bottom + 'px';
        dropdownContainer.style.left = inputRect.left + 'px';
        dropdownContainer.style.width = bezeichnungInput.offsetWidth + 'px';
        dropdownContainer.style.backgroundColor = '#fff'; // Hintergrundfarbe
        dropdownContainer.style.border = '1px solid #ccc'; // Rahmen
        dropdownContainer.style.overflowY = data.length > maxRows ? 'scroll' : 'auto'; // Füge einen Scrollbalken hinzu, wenn mehr als 6 Zeilen vorhanden sind
        dropdownContainer.style.maxHeight = `${maxRows * 20}px`; // Höhe für maximal 6 Zeilen (Annahme: 20px pro Zeile)

        // Verwende ein Set, um eindeutige Werte zu speichern
        const uniqueData = new Set(data);

        uniqueData.forEach((item, index) => {
            const itemElement = document.createElement('div');
            itemElement.classList.add('autocomplete-item');
            itemElement.textContent = item;
            itemElement.addEventListener('click', function () {
                bezeichnungInput.value = item;
                closeAutocompleteDropdown();
            });
            itemElement.addEventListener('mouseenter', function () {
                selectedIndex = index;
                highlightSelectedItem();
            });
            dropdownContainer.appendChild(itemElement);
        });

        document.body.appendChild(dropdownContainer);

        // Füge die CSS-Regel für den Cursor hinzu
        const autocompleteItems = document.querySelectorAll('.autocomplete-item');
        autocompleteItems.forEach(item => {
            item.style.cursor = 'pointer';
        });

        // Füge Event Listener für Pfeiltasten und Enter hinzu
        document.addEventListener('keydown', handleKeyDown);
    };

    // Schließe das Dropdown-Menü der Autocomplete-Funktion.
    const closeAutocompleteDropdown = () => {
        const dropdown = document.querySelector('.autocomplete-dropdown');
        if (dropdown) {
            dropdown.remove();
            document.removeEventListener('keydown', handleKeyDown); // Entferne Event Listener beim Schließen
        }
    };

    // Schließe das Dropdown-Menü beim Klicken außerhalb des Textfelds.
    document.addEventListener('click', function (event) {
        if (!event.target.classList.contains('autocomplete-item') && !event.target.matches('input[placeholder="Bezeichnung"]')) {
            closeAutocompleteDropdown();
        }
    });

    // Hervorhebung des aktuell anvisierten Elements
    const highlightSelectedItem = () => {
        const autocompleteItems = document.querySelectorAll('.autocomplete-item');
        autocompleteItems.forEach((item, index) => {
            if (index === selectedIndex) {
                item.style.backgroundColor = '#f0f0f0'; // Hintergrundfarbe für Anvisierung
            } else {
                item.style.backgroundColor = ''; // Zurücksetzen der Hintergrundfarbe für andere Elemente
            }
        });
    };

    // Behandlung der Tastenereignisse
    const handleKeyDown = (event) => {
        const autocompleteItems = document.querySelectorAll('.autocomplete-item');

        if (event.key === 'ArrowUp' && selectedIndex > 0) {
            selectedIndex--;
        } else if (event.key === 'ArrowDown' && selectedIndex < autocompleteItems.length - 1) {
            selectedIndex++;
        } else if (event.key === 'Enter' && selectedIndex !== -1) {
            const selectedItem = autocompleteItems[selectedIndex];
            if (selectedItem) {
                bezeichnungInput.value = selectedItem.textContent;
                closeAutocompleteDropdown();
            }
        }

        highlightSelectedItem();
    };
});


window.onload = function() {
    startExportTimer(); // Startet den Timer beim Laden der Seite
};

document.addEventListener('keydown', function(event) {
    // Verhindere 'Enter' nur, wenn der Fokus auf einem Textfeld liegt
    const isInputField = event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA';

    if (isInputField && event.key === 'Enter') {
        event.preventDefault(); // Verhindert das Standardverhalten in Textfeldern
    }
});



</script>
</body>
</html>
